[include fluidd.cfg]
#################################################
#                     By                        #
#             Ethereal Project 3D               #
#          www.etherealproject3d.com            #
#     www.youtube.com/c/etherealproject3d       #
#################################################

############################################################################################################################################
#                                                                                                                                          #
#                                                                    NOTE:                                                                 #
#   I used the printer.cfg created by "freakydude" from the Klipper gethub page as a starting point and edited it for this application.    #
#                                                          You can find the origional here;                                                #
#                     https://github.com/Klipper3d/klipper/blob/master/config/printer-artillery-sidewinder-x2-2022.cfg                     #
############################################################################################################################################ 

# This file contains pin mappings for the Artillery Sidewinder X2 (2022) with a Artillery_Ruby-v1.2 board.
# To use this config, during "make menuconfig"

#                         Klipper Firmware Configuration
#[*] Enable extra low-level configuration options
#    Micro-controller Architecture (STMicroelectronics STM32)  --->
#    Processor model (STM32F401)  --->
#    Bootloader offset (No bootloader)  --->
#    Clock Reference (8 MHz crystal)  --->
#    Communication interface (USB (on PA11/PA12))  --->
#    USB ids  --->
#()  GPIO pins to set at micro-controller startup

#############################
# PRINTER SETTINGS
#############################

[exclude_object]

#[include KAMP_Settings.cfg] ; ##### (UNCOMMENT IF USING KAMP)
[firmware_retraction]
retract_length: 1
[include mainsail.cfg]
[include start.cfg]
[include end.cfg]
[include macros.cfg]
[include NozzleClean.cfg]
[include Demon_BTT_Eddy_Offset.cfg]
#[include EDDY.cfg]
#[include BTT-lis2dw-v1.0.cfg]

[pause_resume]

[display_status]

[virtual_sdcard]
path: /home/alon/printer_data/gcodes ; Path may be different for your install, your web interface will give you and error for the expected path, copy and paste expected path here
on_error_gcode: CANCEL_PRINT

#mcu init for relays
[mcu rpi]
serial: /tmp/klipper_host_mcu

[mcu]
serial: /dev/ttyACM0

[printer]
kinematics: cartesian
max_velocity: 200
max_accel: 1500
max_z_velocity: 50
max_z_accel: 600
square_corner_velocity: 5.0

[filament_switch_sensor filament]
pause_on_runout: True # Starts the PAUSE g-code script if filament runs out
runout_gcode: M117 Filament runout # Optional
insert_gcode: M117 Filament insert # Optional
switch_pin: PA0 # the z-endstop pin

#light control
[output_pin lights]
pin: !rpi:gpio15
value: 1
shutdown_value: 0
#psu control
[output_pin psu]
pin: !rpi:gpio14
value: 1
shutdown_value: 0

#############################
# INPUT SHAPER
#############################

[input_shaper]
shaper_type_x = mzv
shaper_freq_x = 55.2
shaper_type_y = 2hump_ei
shaper_freq_y = 51.6

#############################
# MOTION AXES
#############################

[stepper_x]
step_pin: !PB14
dir_pin: PB13
enable_pin: !PB15
microsteps: 16
rotation_distance: 39.42078
endstop_pin: !PA2
position_endstop: 0
position_max: 303
homing_speed: 200
second_homing_speed: 100

[stepper_y]
step_pin: PB10
dir_pin: PB2
enable_pin: !PB12
microsteps: 16
rotation_distance: 39.3409
endstop_pin: !PA1
position_endstop: 3
position_max: 310
homing_speed: 200
second_homing_speed: 50

[stepper_z]
step_pin: PB0
dir_pin: !PC5
enable_pin: !PB1
microsteps: 16
rotation_distance: 7.8207
endstop_pin: probe:z_virtual_endstop #!PC2
#position_endstop: 0

position_max: 400
position_min: -5
homing_speed: 25
second_homing_speed: 10

[extruder]
step_pin: PA7
dir_pin: PA6
enable_pin: !PC4
microsteps: 16
rotation_distance: 21.1691
gear_ratio: 66:22
nozzle_diameter: 0.4000 #0.800
filament_diameter: 1.750
max_extrude_only_distance: 1000
max_extrude_cross_section: 5
pressure_advance: 0.0

#############################
# THERMAL SETTINGS
#############################

[extruder]
heater_pin: PC9
#sensor_type: Generic 3950 ; Common sensor for all metal solution, always reffer to your sensors documentation and the Klipper config refference to ensure correct deffinition
sensor_type: EPCOS 100K B57560G104F ; Stock sensor
sensor_pin: PC0
#control: pid
#pid_kp: 23.059
#pid_ki: 1.337
#pid_kd: 99.442
min_temp: 0
max_temp: 300

[heater_bed]
heater_pin: PA8
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC1
control: pid
pid_kp: 50.058
pid_ki: 0.917
pid_kd: 683.293
min_temp: 0
max_temp: 130

[fan]
pin: PC8
off_below: 0.1

[heater_fan extruder]
pin: PC7
off_below: 0.2

[controller_fan case]
pin: PC6
off_below: 0.3
idle_speed: 0.0

[temperature_sensor mainboard]
sensor_type: temperature_mcu
min_temp: 10
max_temp: 60

#############################
# LEVELING
#############################

#[safe_z_home]
#home_xy_position: 122.5,180
#z_hop: 10
#speed: 125

#[bltouch]
#sensor_pin: PC2
#control_pin: PC3
#x_offset: 27.25
#y_offset: -12.8
##z_offset: 2.0
#speed: 5
#samples: 2
#sample_retract_dist: 8
#samples_tolerance: 0.050
#samples_tolerance_retries: 3

#[bed_mesh]
#speed: 150
#horizontal_move_z: 10
#mesh_min: 30, 15
#mesh_max: 270, 285
#probe_count: 5
#fade_start: 1
#fade_end: 10
#fade_target: 0
#mesh_pps: 2
#algorithm: bicubic

[bed_screws]
screw1: 50,50
screw1_name: front left
screw2: 250,50
screw2_name: front right
screw3: 250,250
screw3_name: back right
screw4: 50,250
screw4_name: back left
speed: 125

[screws_tilt_adjust]
screw1: 22.75,62.8
screw1_name: front left
screw2: 222.75,62.8
screw2_name: front right
screw3: 222.75,262.8
screw3_name: back right
screw4: 22.75,262.8
screw4_name: back left
speed: 125
screw_thread: CW-M5

#############################
# LEDS
#############################

[neopixel extruder]
pin: PB7
initial_RED: 1.0
initial_GREEN: 0
initial_BLUE: 0

[delayed_gcode Welcome_0]
initial_duration: 0
gcode:
  SET_LED LED=extruder RED=1 GREEN=0 BLUE=0

[delayed_gcode Welcome_1]
initial_duration: 0.5
gcode:
  SET_LED LED=extruder RED=0 GREEN=1 BLUE=0

[delayed_gcode Welcome_2]
initial_duration: 1
gcode:
  SET_LED LED=extruder RED=0 GREEN=0 BLUE=1

[delayed_gcode Welcome_3]
initial_duration: 1.5
gcode:
  SET_LED LED=extruder RED=1 GREEN=1 BLUE=1

[delayed_gcode Welcome_4]
initial_duration: 8
gcode:
  SET_LED LED=extruder RED=0.078 GREEN=0.568 BLUE=1

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 16
#*# calibrate =
#*# 	0.048879:3180651.040,0.090427:3179959.329,0.129530:3179255.782,
#*# 	0.171078:3178533.314,0.210181:3177838.836,0.249285:3177112.687,
#*# 	0.290832:3176387.512,0.329936:3175685.270,0.369039:3174982.767,
#*# 	0.410587:3174279.472,0.449690:3173611.541,0.488794:3172946.101,
#*# 	0.530341:3172273.690,0.569445:3171595.624,0.610992:3170913.078,
#*# 	0.650096:3170267.226,0.689199:3169628.862,0.730747:3168967.110,
#*# 	0.769850:3168360.384,0.808954:3167740.251,0.850501:3167087.939,
#*# 	0.889605:3166498.737,0.931152:3165882.930,0.970256:3165321.406,
#*# 	1.009359:3164716.491,1.050907:3164140.036,1.090010:3163603.437,
#*# 	1.129114:3163057.698,1.170661:3162538.314,1.209765:3162026.501,
#*# 	1.248868:3161545.773,1.290415:3161023.248,1.329519:3160520.756,
#*# 	1.371066:3160036.479,1.410170:3159601.899,1.449273:3159174.530,
#*# 	1.490821:3158687.739,1.529924:3158264.825,1.569028:3157822.169,
#*# 	1.610575:3157404.960,1.649679:3156971.687,1.688782:3156574.219,
#*# 	1.730330:3156159.053,1.769433:3155778.326,1.810981:3155379.923,
#*# 	1.850084:3154983.269,1.889188:3154612.724,1.930735:3154226.020,
#*# 	1.969839:3153872.006,2.008942:3153539.897,2.050490:3153171.179,
#*# 	2.089593:3152841.529,2.131141:3152504.037,2.170244:3152200.806,
#*# 	2.209348:3151878.408,2.250895:3151560.564,2.289999:3151246.265,
#*# 	2.329102:3150964.859,2.370650:3150629.364,2.409753:3150351.816,
#*# 	2.448857:3150077.380,2.490404:3149793.316,2.529508:3149494.384,
#*# 	2.571055:3149227.036,2.610159:3148956.971,2.649262:3148698.875,
#*# 	2.690810:3148426.631,2.729913:3148186.889,2.769017:3147917.025,
#*# 	2.810564:3147663.109,2.849668:3147406.093,2.891215:3147162.504,
#*# 	2.930319:3146911.614,2.969422:3146699.878,3.010969:3146428.424,
#*# 	3.050073:3146205.133,3.089176:3145973.758,3.130724:3145758.751,
#*# 	3.169827:3145542.147,3.208931:3145312.797,3.250478:3145086.547,
#*# 	3.289582:3144898.007,3.331129:3144696.478,3.370233:3144477.947,
#*# 	3.409336:3144277.203,3.450884:3144077.588,3.489987:3143888.583,
#*# 	3.529091:3143707.143,3.570638:3143525.462,3.609742:3143339.081,
#*# 	3.648845:3143175.228,3.690393:3142962.018,3.729496:3142793.676,
#*# 	3.771044:3142624.108,3.810147:3142460.194,3.849251:3142296.251,
#*# 	3.890798:3142111.863,3.929902:3141948.223,3.969005:3141806.279,
#*# 	4.010553:3141652.167,4.049656:3141484.730
#*#
#*# [temperature_probe btt_eddy]
#*# calibration_temp = 46.082162
#*# drift_calibration =
#*# 	3143391.228610, 250.360328, -2.222654
#*# 	3137694.340862, 360.276414, -3.217719
#*# 	3135144.788457, 358.255521, -3.180311
#*# 	3133411.404488, 335.092841, -2.938242
#*# 	3130380.260215, 376.629273, -3.291960
#*# 	3127942.501243, 410.937395, -3.583706
#*# 	3126129.675982, 433.196523, -3.787771
#*# 	3125415.446724, 415.686471, -3.583357
#*# 	3123070.458673, 473.933274, -4.159635
#*# drift_calibration_min_temp = 40.44480278907581
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.016677, 0.079415, 0.092139, 0.070040, 0.070124, 0.065743, 0.019509, 0.034205, 0.031954, 0.005760, -0.076079, -0.130101
#*# 	0.080210, 0.043342, 0.045592, 0.056384, 0.051883, 0.065252, 0.042748, 0.029424, 0.019859, -0.034227, -0.073217, -0.102948
#*# 	-0.000688, 0.056798, 0.039596, 0.047797, 0.069838, 0.079844, 0.047377, 0.007297, 0.025408, 0.000988, -0.064257, -0.106844
#*# 	0.059245, 0.047993, 0.052579, 0.052579, 0.039878, 0.065588, 0.056586, 0.034083, 0.019593, -0.029618, -0.057136, -0.086610
#*# 	0.026135, 0.052453, 0.057845, 0.057045, 0.077514, 0.077514, 0.052622, 0.039124, 0.047325, 0.010687, -0.049942, -0.082282
#*# 	0.014947, 0.014947, 0.004327, 0.016024, 0.031183, 0.058185, 0.077721, 0.058562, 0.074472, 0.026837, -0.004320, -0.044725
#*# 	-0.008109, 0.034632, 0.034665, 0.022421, 0.042865, 0.048868, 0.039067, 0.030134, 0.026299, 0.006803, -0.013475, -0.057370
#*# 	-0.009042, -0.032390, 0.006673, 0.002774, 0.010573, 0.025858, 0.025858, 0.018059, 0.033427, -0.020405, -0.018350, -0.018350
#*# 	0.006675, 0.018373, 0.038121, 0.006612, 0.038724, 0.053024, 0.019526, 0.022819, 0.026718, 0.011122, -0.020355, -0.061025
#*# 	-0.031085, -0.048454, -0.028476, -0.033370, -0.028851, -0.001138, 0.009867, -0.025210, 0.002962, -0.021050, -0.041037, -0.015348
#*# 	-0.066190, -0.095210, -0.060403, -0.057403, -0.068583, -0.052851, -0.027336, -0.024911, -0.036652, -0.015246, -0.041307, -0.057089
#*# 	-0.089182, -0.141530, -0.122647, -0.143942, -0.110391, -0.076426, -0.029177, -0.051783, -0.021709, -0.009353, -0.028089, 0.018507
#*# x_count = 12
#*# y_count = 12
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 27.5
#*# max_x = 275.0
#*# min_y = 10.0
#*# max_y = 269.92999999999995
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 30.914
#*# pid_ki = 2.785
#*# pid_kd = 85.787
